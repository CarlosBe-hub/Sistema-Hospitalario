extends layout

block content
  h1 Admisiones

  button.btn.btn-primary.mb-3(data-bs-toggle="modal", data-bs-target="#modalAdmision") + Nueva Admisión

  table#tablaAdmisiones.table.table-hover
    thead
      tr
        th ID
        th Paciente
        th Fecha
        th Tipo Ingreso
        th Estado
        th Acciones
    tbody
      each admision in admisiones
        tr
          td= admision.id_admision
          td= admision.paciente.nombre + ' ' + admision.paciente.apellido
          td= admision.fecha_admision
          td= admision.tipo_ingreso
          td= admision.estado
          td
            button.btn.btn-sm.btn-warning(
              data-bs-toggle="modal",
              data-bs-target="#modalEditarAdmision",
              data-id=admision.id_admision,
              data-paciente=admision.id_paciente,
              data-fecha=admision.fecha_admision,
              data-tipo=admision.tipo_ingreso,
              data-estado=admision.estado
            ) Editar

  // Modal nueva admisión
  .modal.fade#modalAdmision(tabindex="-1")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title Nueva Admisión
          button.btn-close(type="button", data-bs-dismiss="modal")
        form(action="/admision/guardar", method="POST")
          .modal-body
            div#mensajeError.alert.alert-danger(style="display:none")
              | <strong>¡Error!</strong> Este paciente ya tiene una admisión activa. El paciente está actualmente internado.

            div#mensajeBusqueda

            .mb-3
              label.form-label(for="buscar_dni") Buscar por DNI
              .input-group
                input.form-control(type="text", id="buscar_dni", name="buscar_dni", placeholder="Ingrese DNI", value=dni || '')
                button.btn.btn-outline-secondary(type="button", id="btnBuscarDNI") Buscar
              div.text-danger.small#err_dni

            .mb-3
              label.form-label(for="id_paciente") Paciente
              select.form-select(name="id_paciente", id="id_paciente", disabled)
                option(value="") -- Selecciona un paciente --
              div.text-danger.small#err_paciente

            .mb-3
              label.form-label(for="fecha_admision") Fecha de Admisión
              input.form-control(type="datetime-local", name="fecha_admision", id="fecha_admision")
              div.text-danger.small#err_fecha

            .mb-3
              label.form-label(for="tipo_ingreso") Tipo de Ingreso
              select.form-select(name="tipo_ingreso", id="tipo_ingreso")
                option(value="") -- Selecciona un tipo --
                option(value="Urgencia") Urgencia
                option(value="Derivado") Derivado
              div.text-danger.small#err_tipo

          .modal-footer
            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cerrar
            button.btn.btn-primary(type="submit", id="btnGuardarAdmision", disabled) Guardar

  // Modal editar admisión
  .modal.fade#modalEditarAdmision(tabindex="-1")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title Editar Admisión
          button.btn-close(type="button", data-bs-dismiss="modal")
        form#formEditarAdmision(method="POST")
          input(type="hidden", name="_method", value="PUT")
          input(type="hidden", name="id_admision", id="edit_id_admision")

          .modal-body
            .mb-3
              label.form-label(for="edit_fecha_admision") Fecha de Admisión
              input.form-control(type="datetime-local", name="fecha_admision", id="edit_fecha_admision")
              div.text-danger.small#err_edit_fecha

            .mb-3
              label.form-label(for="edit_tipo_ingreso") Tipo de Ingreso
              select.form-select(name="tipo_ingreso", id="edit_tipo_ingreso")
                option(value="Urgencia") Urgencia
                option(value="Derivado") Derivado
              div.text-danger.small#err_edit_tipo

            .mb-3
              label.form-label(for="edit_estado") Estado
              select.form-select(name="estado", id="edit_estado")
                option(value="activo") Activo
                option(value="finalizado") Finalizado
                option(value="cancelado") Cancelado
                option(value="en proceso...") En Proceso...
              div.text-danger.small#err_edit_estado

          .modal-footer
            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cerrar
            button.btn.btn-primary(type="submit") Guardar cambios

  // CSS y JS externos
  link(rel="stylesheet", href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css")
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script(src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js")

  // Script personalizado
  script.
    $(document).ready(function() {
      $('#tablaAdmisiones').DataTable({
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        responsive: true
      });

      function formatearFecha(fechaStr) {
        if (!fechaStr) return '';
        const fecha = new Date(fechaStr);
        if (isNaN(fecha)) return fechaStr;
        const dia = String(fecha.getDate()).padStart(2, '0');
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const anio = fecha.getFullYear();
        const horas = String(fecha.getHours()).padStart(2, '0');
        const minutos = String(fecha.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${anio} ${horas}:${minutos}`;
      }

      $('#tablaAdmisiones tbody tr').each(function() {
        const $celdaFecha = $(this).find('td').eq(2);
        const fechaTexto = $celdaFecha.text().trim();
        const fechaFormateada = formatearFecha(fechaTexto);
        $celdaFecha.text(fechaFormateada);
      });

      $('#modalEditarAdmision').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const idAdmision = button.data('id');
        const fecha = button.data('fecha');
        const tipo = button.data('tipo');
        const estado = button.data('estado');

        const modal = $(this);
        modal.find('#edit_id_admision').val(idAdmision);
        modal.find('#edit_fecha_admision').val(fecha);
        modal.find('#edit_tipo_ingreso').val(tipo);
        modal.find('#edit_estado').val(estado);

        const form = modal.find('#formEditarAdmision');
        form.attr('action', `/admision/${idAdmision}?_method=PUT`);
      });

      function mostrarMensaje(tipo, texto) {
        const mensaje = document.getElementById('mensajeBusqueda');
        mensaje.innerHTML = `
          <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
            ${texto}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        `;
      }

      document.getElementById('btnBuscarDNI').addEventListener('click', async () => {
        const dni = document.getElementById('buscar_dni').value.trim();
        const errorDiv = document.getElementById('err_dni');
        const select = document.getElementById('id_paciente');
        const btnGuardar = document.getElementById('btnGuardarAdmision');
        const mensajeError = document.getElementById('mensajeError');

        errorDiv.textContent = '';
        select.innerHTML = '<option value="">-- Selecciona un paciente --</option>';
        select.disabled = true;
        btnGuardar.disabled = true;
        mensajeError.style.display = 'none';

        if (!dni || dni.length < 6) {
          errorDiv.textContent = 'Ingrese un DNI válido.';
          return;
        }

        try {
          const res = await fetch(`/admision/buscar-paciente/${dni}`);
          if (!res.ok) throw await res.json();

          const paciente = await res.json();

          if (paciente.admisionActiva) {
            mensajeError.style.display = 'block';
            mensajeError.innerHTML = `<strong>¡Error!</strong> Este paciente ya tiene una admisión activa. El paciente está actualmente internado.`;
            return;
          }

          const option = document.createElement('option');
          option.value = paciente.id_paciente;
          option.textContent = `${paciente.nombre} ${paciente.apellido}`;
          select.appendChild(option);
          select.disabled = false;
          select.value = paciente.id_paciente;
          btnGuardar.disabled = false;

          mostrarMensaje('success', `✅ Paciente encontrado: ${paciente.nombre} ${paciente.apellido}`);
        } catch (err) {
          mostrarMensaje('warning', `⚠️ Paciente no registrado. ¿Deseas <a href="/pacientes?nuevo=1&dni=${dni}" class="alert-link">crear uno nuevo?</a>`);
        }
      });

      function validarFormularioAdmision() {
        const dni = $('#buscar_dni').val().trim();
        const paciente = $('#id_paciente').val();
        const fechaAdmision = $('#fecha_admision').val();
        const tipoIngreso = $('#tipo_ingreso').val();
        let valido = true;

        if (!dni || dni.length < 6) {
          $('#err_dni').text('Ingrese un DNI válido.');
          valido = false;
        } else {
          $('#err_dni').text('');
        }

        if (!paciente) {
          $('#err_paciente').text('Seleccione un paciente.');
          valido = false;
        } else {
          $('#err_paciente').text('');
        }

        if (!fechaAdmision) {
          $('#err_fecha').text('La fecha de admisión es obligatoria.');
          valido = false;
        } else {
          $('#err_fecha').text('');
        }

        if (!tipoIngreso) {
          $('#err_tipo').text('Seleccione un tipo de ingreso.');
          valido = false;
        } else {
          $('#err_tipo').text('');
        }

        return valido;
      }

      $('form[action="/admision/guardar"]').on('submit', function (e) {
        e.preventDefault();

        if (validarFormularioAdmision()) {
          this.submit();
        }
      });
    });
