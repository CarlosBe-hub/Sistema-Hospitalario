extends layout

block content
  h1 Admisiones

  button.btn.btn-primary.mb-3(data-bs-toggle="modal", data-bs-target="#modalAdmision") + Nueva Admisión

  table#tablaAdmisiones.table.table-hover
    thead
      tr
        th ID
        th Paciente
        th Fecha
        th Tipo Ingreso
        th Estado
        th Acciones
    tbody
      each admision in admisiones
        tr
          td= admision.id_admision
          td= admision.paciente.nombre + ' ' + admision.paciente.apellido
          td= admision.fecha_admision
          td= admision.tipo_ingreso
          td= admision.estado
          td
            button.btn.btn-sm.btn-warning(
              type="button",
              data-bs-toggle="modal",
              data-bs-target="#modalEditarAdmision",
              data-id=admision.id_admision,
              data-paciente=admision.id_paciente,
              data-fecha=admision.fecha_admision,
              data-tipo=admision.tipo_ingreso,
              data-estado=admision.estado
            ) Editar
            if admision.estado == 'activo'
              button.btn.btn-sm.btn-danger(
                type="button",
                data-id=admision.id_admision,
                onclick="cancelarAdmision(this)"
              ) Cancelar

  // Modal nueva admisión
  .modal.fade#modalAdmision(tabindex="-1", aria-hidden="true")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title Nueva Admisión
          button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Cerrar")
        form#formNuevaAdmision
          .modal-body
            div#mensajeError.alert.alert-danger(style="display:none")
              strong ¡Error! 
              | Este paciente ya tiene una admisión activa. El paciente está actualmente internado.

            div#mensajeBusqueda

            .mb-3
              label.form-label(for="buscar_dni") Buscar por DNI
              .input-group
                input.form-control(type="text", id="buscar_dni", name="buscar_dni", placeholder="Ingrese DNI", value=dni || '')
                button.btn.btn-outline-secondary(type="button", id="btnBuscarDNI") Buscar
              div.text-danger.small#err_dni

            .mb-3
              label.form-label(for="id_paciente") Paciente
              select.form-select(name="id_paciente", id="id_paciente", disabled)
                option(value="") -- Selecciona un paciente --
              div.text-danger.small#err_paciente

            .mb-3
              label.form-label(for="fecha_admision") Fecha de Admisión
              input.form-control(type="datetime-local", name="fecha_admision", id="fecha_admision")
              div.text-danger.small#err_fecha

            .mb-3
              label.form-label(for="tipo_ingreso") Tipo de Ingreso
              select.form-select(name="tipo_ingreso", id="tipo_ingreso")
                option(value="") -- Selecciona un tipo --
                option(value="Urgencia") Urgencia
                option(value="Derivado") Derivado
              div.text-danger.small#err_tipo

          .modal-footer
            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cerrar
            button.btn.btn-primary(type="submit", id="btnGuardarAdmision", disabled) Guardar

  // Modal editar admisión
  .modal.fade#modalEditarAdmision(tabindex="-1", aria-hidden="true")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title Editar Admisión
          button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Cerrar")
        form#formEditarAdmision(method="POST", action="/admision/0")
          input(type="hidden", name="_method", value="PUT")
          input(type="hidden", name="id_admision", id="edit_id_admision")
          input(type="hidden", name="id_paciente", id="edit_id_paciente")

          .modal-body
            .mb-3
              label.form-label(for="edit_fecha_admision") Fecha de Admisión
              input.form-control(type="datetime-local", name="fecha_admision", id="edit_fecha_admision")
              div.text-danger.small#err_edit_fecha

            .mb-3
              label.form-label(for="edit_tipo_ingreso") Tipo de Ingreso
              select.form-select(name="tipo_ingreso", id="edit_tipo_ingreso")
                option(value="Urgencia") Urgencia
                option(value="Derivado") Derivado
              div.text-danger.small#err_edit_tipo

            .mb-3
              label.form-label(for="edit_estado") Estado
              select.form-select(name="estado", id="edit_estado")
                option(value="activo") Activo
                option(value="cancelado") Cancelado
              div.text-danger.small#err_edit_estado

          .modal-footer
            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cerrar
            button.btn.btn-primary(type="submit") Guardar cambios

block scripts
  link(rel="stylesheet", href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css")
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script(src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js")

  script.
    $(document).ready(function () {
      $('#tablaAdmisiones').DataTable({
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        responsive: true
      });

      function formatearFecha(fechaStr) {
        if (!fechaStr) return '';
        const fecha = new Date(fechaStr);
        if (isNaN(fecha)) return fechaStr;
        const dia = String(fecha.getDate()).padStart(2, '0');
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const anio = fecha.getFullYear();
        const horas = String(fecha.getHours()).padStart(2, '0');
        const minutos = String(fecha.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${anio} ${horas}:${minutos}`;
      }

      $('#tablaAdmisiones tbody tr').each(function () {
        const $celdaFecha = $(this).find('td').eq(2);
        const fechaTexto = $celdaFecha.text().trim();
        const fechaFormateada = formatearFecha(fechaTexto);
        $celdaFecha.text(fechaFormateada);
      });

      // Definir la función cancelarAdmision
      window.cancelarAdmision = function(button) {
        const idAdmision = $(button).data('id');  // Obtener el ID de la admisión desde el botón
        if (confirm("¿Estás seguro de que deseas cancelar esta admisión?")) {
          $.ajax({
            url: `/admision/${idAdmision}/cancelar`,  // La URL del backend
            method: 'PUT',  // Usamos PUT para cambiar el estado
            success: function(res) {
              alert('Admision cancelada correctamente');
              location.reload();  // Recargar la página para actualizar la tabla
            },
            error: function(xhr, status, error) {
              alert('Error al cancelar la admisión');
            }
          });
        }
      }

      $('#modalEditarAdmision').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const idAdmision = button.data('id');
        const fecha = button.data('fecha');
        const tipo = button.data('tipo');
        const estado = button.data('estado');
        const pacienteId = button.data('paciente');

        const modal = $(this);
        modal.find('#edit_id_admision').val(idAdmision);
        modal.find('#edit_fecha_admision').val(fecha);
        modal.find('#edit_tipo_ingreso').val(tipo);
        modal.find('#edit_estado').val(estado);
        modal.find('#edit_id_paciente').val(pacienteId);

        modal.find('form').attr('action', `/admision/${idAdmision}?_method=PUT`);
      });
    });
